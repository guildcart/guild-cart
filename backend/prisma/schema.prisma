generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  discordId     String    @unique @map("discord_id")
  email         String?
  username      String
  avatar        String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  ownedServers  Server[]  @relation("ServerOwner")
  orders        Order[]
  
  @@map("users")
}

enum SubscriptionTier {
  FREE
  STARTER
  PRO
  BUSINESS
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  EXPIRED
}

model Server {
  id                    String              @id @default(uuid())
  discordServerId       String              @unique @map("discord_server_id")
  shopName              String              @map("shop_name")
  description           String?
  ownerId               String              @map("owner_id")
  stripeAccountId       String?             @unique @map("stripe_account_id")
  subscriptionTier      SubscriptionTier    @default(FREE) @map("subscription_tier")
  subscriptionStatus    SubscriptionStatus  @default(ACTIVE) @map("subscription_status")
  commissionRate        Float               @default(5.0) @map("commission_rate")
  stripeSubscriptionId  String?             @unique @map("stripe_subscription_id")
  subscriptionExpiresAt DateTime?           @map("subscription_expires_at")
  active                Boolean             @default(true)
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  owner                 User                @relation("ServerOwner", fields: [ownerId], references: [id])
  products              Product[]
  orders                Order[]
  
  @@map("servers")
}

enum ProductType {
  PDF
  ACCOUNT
  SERIAL
}

model Product {
  id                  String      @id @default(uuid())
  serverId            String      @map("server_id")
  name                String
  description         String
  price               Float
  type                ProductType
  fileUrl             String?     @map("file_url")
  discordSERIALId       String?     @map("discord_role_id")
  serialCredentials   String?     @map("serial_credentials")  // ðŸ†• RENOMMÃ‰ (ancien: account_credentials)
  stock               Int?        @default(0)
  salesCount          Int         @default(0) @map("sales_count")
  active              Boolean     @default(true)
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  server              Server      @relation(fields: [serverId], references: [id], onDelete: Cascade)
  orders              Order[]
  
  @@map("products")
  @@index([serverId])
}

enum OrderStatus {
  PENDING
  COMPLETED
  REFUNDED
  FAILED
}

model Order {
  id                      String      @id @default(uuid())
  serverId                String      @map("server_id")
  buyerId                 String      @map("buyer_id")
  productId               String      @map("product_id")
  stripePaymentIntentId   String      @unique @map("stripe_payment_intent_id")
  status                  OrderStatus @default(PENDING)
  amount                  Float
  commissionAmount        Float       @map("commission_amount")
  deliveryData            String?     @map("delivery_data")
  delivered               Boolean     @default(false)
  deliveredAt             DateTime?   @map("delivered_at")
  createdAt               DateTime    @default(now()) @map("created_at")
  updatedAt               DateTime    @updatedAt @map("updated_at")

  server                  Server      @relation(fields: [serverId], references: [id])
  buyer                   User        @relation(fields: [buyerId], references: [id])
  product                 Product     @relation(fields: [productId], references: [id])
  
  @@map("orders")
  @@index([serverId])
  @@index([buyerId])
  @@index([status])
}

model Transaction {
  id                  String    @id @default(uuid())
  serverId            String    @map("server_id")
  orderId             String?   @map("order_id")
  type                String
  amount              Float
  commissionAmount    Float     @map("commission_amount")
  stripeTransferId    String?   @unique @map("stripe_transfer_id")
  metadata            String?
  createdAt           DateTime  @default(now()) @map("created_at")

  @@map("transactions")
  @@index([serverId])
  @@index([type])
  @@index([createdAt])
}